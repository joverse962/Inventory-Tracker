---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Test Upload">
  <div class="p-6 max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Test Image Upload</h1>
    
    <div class="bg-white p-6 rounded-lg shadow">
      <form id="testForm">
        <div class="mb-4">
          <label class="block mb-2">Select Image:</label>
          <input type="file" id="testFile" accept="image/*" class="border p-2" />
        </div>
        
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">
          Test Upload
        </button>
      </form>
      
      <div id="result" class="mt-4 p-4 bg-gray-100 rounded hidden"></div>
      
      <div id="testImage" class="mt-4 hidden">
        <h3 class="font-bold mb-2">Uploaded Image:</h3>
        <img id="uploadedImg" src="" alt="Test" class="max-w-md" />
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { uploadAPI, itemsAPI } from '../lib/api';
  
  const form = document.getElementById('testForm') as HTMLFormElement;
  const fileInput = document.getElementById('testFile') as HTMLInputElement;
  const result = document.getElementById('result');
  const testImage = document.getElementById('testImage');
  const uploadedImg = document.getElementById('uploadedImg') as HTMLImageElement;
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const file = fileInput.files?.[0];
    if (!file) {
      alert('Please select a file');
      return;
    }
    
    try {
      console.log('=== UPLOAD TEST START ===');
      console.log('File:', file.name, 'Size:', file.size, 'Type:', file.type);
      
      // Step 1: Upload image
      const uploadResult = await uploadAPI.uploadImage(file);
      console.log('Upload result:', uploadResult);
      
      if (result) {
        result.textContent = `✓ Upload Success!\nURL: ${uploadResult.url}\nFilename: ${uploadResult.filename}`;
        result.classList.remove('hidden');
        result.classList.add('bg-green-100');
      }
      
      // Step 2: Show the image
      if (uploadedImg && testImage) {
        uploadedImg.src = uploadResult.url;
        testImage.classList.remove('hidden');
      }
      
      // Step 3: Create a test item
      const testItemData = {
        name: `Test Item - ${Date.now()}`,
        description: 'This is a test item to verify image upload',
        category: 'Test',
        location: 'Test Location',
        quantity: 1,
        image: uploadResult.url
      };
      
      console.log('Creating test item:', testItemData);
      const createResult = await itemsAPI.create(testItemData);
      console.log('Item created:', createResult);
      
      alert('Test successful! Check console for details. Item ID: ' + createResult.item._id);
      
    } catch (error: any) {
      console.error('Test failed:', error);
      if (result) {
        result.textContent = `✗ Error: ${error.message}`;
        result.classList.remove('hidden');
        result.classList.add('bg-red-100');
      }
    }
  });
</script>
