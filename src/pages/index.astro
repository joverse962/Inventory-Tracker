---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Dashboard - Inventory Tracker">
  <div class="p-6">
    <!-- Header with User Info -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-[#4B0082]">Inventory Dashboard</h1>
        <p id="userWelcome" class="text-gray-600 mt-1">Welcome back!</p>
      </div>
      <button
        id="logoutBtn"
        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
      >
        Logout
      </button>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-gray-500 text-sm">Total Items</div>
        <div id="totalItems" class="text-3xl font-bold text-gray-900">0</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-gray-500 text-sm">Available</div>
        <div id="availableItems" class="text-3xl font-bold text-green-600">0</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-gray-500 text-sm">Borrowed</div>
        <div id="borrowedItems" class="text-3xl font-bold text-yellow-600">0</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-gray-500 text-sm">In Use</div>
        <div id="usedItems" class="text-3xl font-bold text-gray-600">0</div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Search items..."
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        />
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="borrowed">Borrowed</option>
          <option value="used">In Use</option>
          <option value="waste">Waste</option>
        </select>
        <select
          id="categoryFilter"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        >
          <option value="">All Categories</option>
          <!-- dynamic options injected by script -->
        </select>
        <select
          id="locationFilter"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        >
          <option value="">All Locations</option>
          <!-- dynamic options injected by script -->
        </select>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-gray-600">Loading items...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6"></div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
      <svg class="mx-auto h-24 w-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
      </svg>
      <h3 class="mt-4 text-lg font-medium text-gray-900">No items found</h3>
      <p class="mt-2 text-gray-600">Get started by adding your first inventory item.</p>
      <a href="/add-item" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Add Item
      </a>
    </div>

    <!-- Items Grid -->
    <div id="itemsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden">
      <!-- Items will be inserted here -->
    </div>
  </div>

  <!-- Item Modal -->
  <div id="itemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <h2 id="modalTitle" class="text-2xl font-bold text-gray-900"></h2>
          <button id="closeModal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="modalContent">
          <!-- Modal content will be inserted here -->
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { checkAuth } from '../lib/middleware';
  import { itemsAPI, logout, getCurrentUser } from '../lib/api';

  // Check authentication
  checkAuth();

  let allItems: any[] = [];
  // keep a master list of all possible categories/locations so filters don't disappear
  let categoriesList: string[] = [];
  let locationsList: string[] = [];

  let currentFilters = {
    search: '',
    status: '',
    category: '',
    location: '',
  };

  // rebuild select options using the master lists
  function populateFilters() {
    const catSelect = document.getElementById('categoryFilter') as HTMLSelectElement;
    const locSelect = document.getElementById('locationFilter') as HTMLSelectElement;
    if (!catSelect || !locSelect) return;

    const prevCat = catSelect.value;
    const prevLoc = locSelect.value;

    // helper to rebuild options list with a remembered value
    function rebuild(select: HTMLSelectElement, items: string[], placeholder: string, prevValue: string) {
      select.innerHTML = `<option value="">${placeholder}</option>`;
      items.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        if (val === prevValue) {
          opt.selected = true;
        }
        select.appendChild(opt);
      });
      // ensure the old value stays if it was empty or not found
      if (prevValue && !items.includes(prevValue)) {
        select.value = prevValue;
      }
    }

    rebuild(catSelect, categoriesList, 'All Categories', prevCat);
    rebuild(locSelect, locationsList, 'All Locations', prevLoc);
  }

  // Get current user and display welcome message
  const user = getCurrentUser();
  const userWelcome = document.getElementById('userWelcome');
  if (userWelcome && user) {
    userWelcome.textContent = `Welcome back, ${user.name}!`;
  }

  // Logout handler
  document.getElementById('logoutBtn')?.addEventListener('click', logout);

  // load master lists (unfiltered) once or when items change
  async function refreshOptionLists() {
    try {
      const data = await itemsAPI.getAll();
      const masterItems = data.items || [];
      categoriesList = Array.from(new Set(masterItems.map(i => i.category).filter(Boolean))).sort();
      locationsList = Array.from(new Set(masterItems.map(i => i.location).filter(Boolean))).sort();
      populateFilters();
    } catch (err) {
      console.error('[Dashboard] Failed to refresh option lists', err);
    }
  }

  // Fetch items
  async function fetchItems() {
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const emptyState = document.getElementById('emptyState');
    const itemsGrid = document.getElementById('itemsGrid');

    // make sure the master lists are populated at least once
    if (categoriesList.length === 0 && locationsList.length === 0) {
      await refreshOptionLists();
    }

    try {
      loadingState?.classList.remove('hidden');
      errorState?.classList.add('hidden');
      emptyState?.classList.add('hidden');
      itemsGrid?.classList.add('hidden');

      const data = await itemsAPI.getAll(currentFilters);
      allItems = data.items || [];

      // keep our master lists up to date in case new categories/locations appeared
      await refreshOptionLists();

      console.log('[Dashboard] Fetched items:', allItems.length);

      // populate category & location selects based on data
      populateFilters();
      if (allItems.length > 0) {
        console.log('[Dashboard] First item sample:', {
          name: allItems[0].name,
          image: allItems[0].image,
          hasImage: !!allItems[0].image
        });
      }

      loadingState?.classList.add('hidden');

      if (allItems.length === 0) {
        emptyState?.classList.remove('hidden');
      } else {
        itemsGrid?.classList.remove('hidden');
        renderItems();
      }

      updateStatistics();
    } catch (error: any) {
      loadingState?.classList.add('hidden');
      if (errorState) {
        errorState.textContent = error.message || 'Failed to load items';
        errorState.classList.remove('hidden');
      }
    }
  }

  // Render items
  function renderItems() {
    const itemsGrid = document.getElementById('itemsGrid');
    if (!itemsGrid) return;

    itemsGrid.innerHTML = allItems.map(item => {
      const statusColors = {
        available: 'bg-green-100 text-green-800',
        borrowed: 'bg-yellow-100 text-yellow-800',
        used: 'bg-gray-100 text-gray-800',
        waste: 'bg-red-100 text-red-800',
      };

      const statusColor = statusColors[item.status as keyof typeof statusColors] || 'bg-gray-100 text-gray-800';

      return `
        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer item-card" data-id="${item._id}">
          ${item.image ? `
            <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover" />
          ` : `
            <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
              <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
              </svg>
            </div>
          `}
          <div class="p-4">
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-lg font-semibold text-gray-900">${item.name}</h3>
              <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
                ${item.status}
              </span>
            </div>
            <p class="text-sm text-gray-600 mb-2 line-clamp-2">${item.description}</p>
            <div class="text-xs text-gray-500">
              <div>üìç ${item.location}</div>
              <div>üè∑Ô∏è ${item.category}</div>
              ${item.barcode ? `<div>üîñ ${item.barcode}</div>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Add click handlers
    document.querySelectorAll('.item-card').forEach(card => {
      card.addEventListener('click', () => {
        const itemId = card.getAttribute('data-id');
        const item = allItems.find(i => i._id === itemId);
        if (item) showItemModal(item);
      });
    });
  }

  // Show item modal
  function showItemModal(item: any) {
    const modal = document.getElementById('itemModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    if (!modal || !modalTitle || !modalContent) return;

    modalTitle.textContent = item.name;

    const statusColors = {
      available: 'bg-green-100 text-green-800',
      borrowed: 'bg-yellow-100 text-yellow-800',
      used: 'bg-gray-100 text-gray-800',
      waste: 'bg-red-100 text-red-800',
    };

    const statusColor = statusColors[item.status as keyof typeof statusColors] || 'bg-gray-100 text-gray-800';

    modalContent.innerHTML = `
      ${item.image ? `<img src="${item.image}" alt="${item.name}" class="w-full h-64 object-cover rounded-lg mb-4" />` : ''}
      
      <div class="space-y-4">
        <div>
          <span class="px-3 py-1 text-sm font-medium rounded-full ${statusColor}">${item.status}</span>
        </div>
        
        <div>
          <h3 class="font-semibold text-gray-700">Description</h3>
          <p class="text-gray-600">${item.description}</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="font-semibold text-gray-700">Category</h3>
            <p class="text-gray-600">${item.category}</p>
          </div>
          <div>
            <h3 class="font-semibold text-gray-700">Location</h3>
            <p class="text-gray-600">${item.location}</p>
          </div>
          <div>
            <h3 class="font-semibold text-gray-700">Quantity</h3>
            <p class="text-gray-600">${item.quantity}</p>
          </div>
          ${item.barcode ? `
            <div>
              <h3 class="font-semibold text-gray-700">Barcode</h3>
              <p class="text-gray-600 font-mono">${item.barcode}</p>
            </div>
          ` : ''}
        </div>
        
        ${item.components && item.components.length > 0 ? `
          <div>
            <h3 class="font-semibold text-gray-700 mb-2">Components</h3>
            <ul class="space-y-1">
              ${item.components.map((c: any) => `
                <li class="text-gray-600">‚Ä¢ ${c.name} (${c.quantity}x)</li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${item.borrowedBy ? `
          <div>
            <h3 class="font-semibold text-gray-700">Borrowed By</h3>
            <p class="text-gray-600">${item.borrowedBy.name}</p>
            <p class="text-sm text-gray-500">${new Date(item.borrowedAt).toLocaleDateString()}</p>
          </div>
        ` : ''}
        
        <div class="flex gap-2 pt-4">
          ${item.status === 'available' ? `
            <button class="action-btn flex-1 bg-[#4B0082] text-white px-4 py-2 rounded-lg hover:bg-violet-950" data-action="borrow" data-id="${item._id}">
              Borrow
            </button>
          ` : ''}
          ${item.status === 'borrowed' && user && item.borrowedBy && String(item.borrowedBy._id) === user.id ? `
            <button class="action-btn flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" data-action="return" data-id="${item._id}">
              Return
            </button>
          ` : ''}
          ${user && item.createdBy && String(item.createdBy._id) === user.id ? `
            <button class="action-btn flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" data-action="delete" data-id="${item._id}">
              Delete
            </button>
          ` : ''}
        </div>
      </div>
    `;

    // Add action handlers
    modalContent.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.target as HTMLButtonElement;
        const action = target.getAttribute('data-action');
        const id = target.getAttribute('data-id');
        
        if (!id) return;
        
        try {
          if (action === 'borrow') {
            await itemsAPI.borrow(id);
          } else if (action === 'return') {
            await itemsAPI.return(id);
          } else if (action === 'delete') {
            if (confirm('Are you sure you want to delete this item?')) {
              await itemsAPI.delete(id);
            } else {
              return;
            }
          }
          
          modal.classList.add('hidden');
          fetchItems();
        } catch (error: any) {
          alert(error.message || 'Action failed');
        }
      });
    });

    modal.classList.remove('hidden');
  }

  // Close modal
  document.getElementById('closeModal')?.addEventListener('click', () => {
    document.getElementById('itemModal')?.classList.add('hidden');
  });

  document.getElementById('itemModal')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      document.getElementById('itemModal')?.classList.add('hidden');
    }
  });

  // Update statistics
  function updateStatistics() {
    const total = allItems.length;
    const available = allItems.filter(i => i.status === 'available').length;
    const borrowed = allItems.filter(i => i.status === 'borrowed').length;
    const used = allItems.filter(i => i.status === 'used').length;

    document.getElementById('totalItems')!.textContent = total.toString();
    document.getElementById('availableItems')!.textContent = available.toString();
    document.getElementById('borrowedItems')!.textContent = borrowed.toString();
    document.getElementById('usedItems')!.textContent = used.toString();
  }

  // Filter handlers
  let filterTimeout: number;

  function handleFilterChange() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      currentFilters = {
        search: (document.getElementById('searchInput') as HTMLInputElement).value,
        status: (document.getElementById('statusFilter') as HTMLSelectElement).value,
        category: (document.getElementById('categoryFilter') as HTMLSelectElement).value,
        location: (document.getElementById('locationFilter') as HTMLSelectElement).value,
      };
      fetchItems();
    }, 300);
  }

  document.getElementById('searchInput')?.addEventListener('input', handleFilterChange);
  document.getElementById('statusFilter')?.addEventListener('change', handleFilterChange);
  document.getElementById('categoryFilter')?.addEventListener('change', handleFilterChange);
  document.getElementById('locationFilter')?.addEventListener('change', handleFilterChange);

  // Initial load
  fetchItems();
</script>
