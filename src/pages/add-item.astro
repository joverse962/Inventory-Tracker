---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Add Item - Inventory Tracker">
  <div class="p-6 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">➕ Add New Item</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-6">
      <form id="addItemForm" class="space-y-6">
        <!-- Item Name -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
            Item Name *
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="e.g., Dell Laptop XPS 15"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Description *
          </label>
          <textarea
            id="description"
            name="description"
            required
            rows="4"
            placeholder="Detailed description of the item..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          ></textarea>
        </div>

        <!-- Category and Location Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
              Category *
            </label>
            <input
              type="text"
              id="category"
              name="category"
              required
              placeholder="e.g., Electronics"
              list="categoryOptions"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <datalist id="categoryOptions">
              <option value="Electronics">
              <option value="Furniture">
              <option value="Office Supplies">
              <option value="Tools">
              <option value="Equipment">
            </datalist>
          </div>

          <div>
            <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
              Location *
            </label>
            <input
              type="text"
              id="location"
              name="location"
              required
              placeholder="e.g., Warehouse A"
              list="locationOptions"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <datalist id="locationOptions">
              <option value="Warehouse A">
              <option value="Warehouse B">
              <option value="Office Floor 1">
              <option value="Office Floor 2">
              <option value="Storage Room">
            </datalist>
          </div>
        </div>

        <!-- Quantity -->
        <div>
          <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">
            Quantity
          </label>
          <input
            type="number"
            id="quantity"
            name="quantity"
            min="1"
            value="1"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <!-- Photo Upload -->
        <div>
          <label for="photo" class="block text-sm font-medium text-gray-700 mb-2">
            Item Photo
          </label>
          <input
            type="file"
            id="photo"
            name="photo"
            accept="image/*"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p class="text-sm text-gray-500 mt-1">Max file size: 5MB. Formats: JPEG, PNG, WebP</p>
          
          <!-- Image Preview -->
          <div id="imagePreview" class="mt-4 hidden">
            <img id="previewImg" src="" alt="Preview" class="max-w-xs rounded-lg" />
          </div>
        </div>

        <!-- Components Section -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-medium text-gray-700">
              Components / Accessories
            </label>
            <button
              type="button"
              id="addComponentBtn"
              class="text-sm text-blue-600 hover:text-blue-700 font-medium"
            >
              + Add Component
            </button>
          </div>
          <div id="componentsContainer" class="space-y-2">
            <!-- Components will be added here -->
          </div>
        </div>

        <!-- Barcode (Optional) -->
        <div>
          <label for="barcode" class="block text-sm font-medium text-gray-700 mb-2">
            Barcode (Optional)
          </label>
          <input
            type="text"
            id="barcode"
            name="barcode"
            placeholder="Leave empty to auto-generate"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p class="text-sm text-gray-500 mt-1">If left empty, a barcode will be automatically generated</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded"></div>

        <!-- Buttons -->
        <div class="flex gap-4">
          <button
            type="submit"
            id="submitBtn"
            class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition font-medium"
          >
            Add Item
          </button>
          <a
            href="/"
            class="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition font-medium text-center"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<script>
  import { checkAuth } from '../lib/middleware';
  import { itemsAPI, uploadAPI } from '../lib/api';

  // Check authentication
  checkAuth();

  const form = document.getElementById('addItemForm') as HTMLFormElement;
  const photoInput = document.getElementById('photo') as HTMLInputElement;
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg') as HTMLImageElement;
  const componentsContainer = document.getElementById('componentsContainer');
  const addComponentBtn = document.getElementById('addComponentBtn');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  let components: Array<{ name: string; quantity: number }> = [];

  // Image preview
  photoInput?.addEventListener('change', (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        if (previewImg && imagePreview) {
          previewImg.src = e.target?.result as string;
          imagePreview.classList.remove('hidden');
        }
      };
      reader.readAsDataURL(file);
    }
  });

  // Add component
  addComponentBtn?.addEventListener('click', () => {
    const index = components.length;
    components.push({ name: '', quantity: 1 });

    const componentDiv = document.createElement('div');
    componentDiv.className = 'flex gap-2 items-center';
    componentDiv.innerHTML = `
      <input
        type="text"
        placeholder="Component name"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        data-component-index="${index}"
        data-field="name"
      />
      <input
        type="number"
        min="1"
        value="1"
        placeholder="Qty"
        class="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        data-component-index="${index}"
        data-field="quantity"
      />
      <button
        type="button"
        class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 remove-component"
        data-index="${index}"
      >
        ✕
      </button>
    `;

    componentsContainer?.appendChild(componentDiv);

    // Add input listeners
    componentDiv.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        const idx = parseInt(target.getAttribute('data-component-index') || '0');
        const field = target.getAttribute('data-field') as 'name' | 'quantity';
        
        if (field === 'name') {
          components[idx].name = target.value;
        } else if (field === 'quantity') {
          components[idx].quantity = parseInt(target.value) || 1;
        }
      });
    });

    // Add remove listener
    componentDiv.querySelector('.remove-component')?.addEventListener('click', (e) => {
      const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0');
      components.splice(idx, 1);
      componentDiv.remove();
    });
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    errorMessage?.classList.add('hidden');
    successMessage?.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding Item...';

    try {
      // Get form values
      const formData = new FormData(form);
      const name = formData.get('name') as string;
      const description = formData.get('description') as string;
      const category = formData.get('category') as string;
      const location = formData.get('location') as string;
      const quantity = parseInt(formData.get('quantity') as string) || 1;
      const barcode = formData.get('barcode') as string || undefined;
      const photoFile = formData.get('photo') as File;

      // Upload photo if provided
      let imageUrl = '';
      if (photoFile && photoFile.size > 0) {
        try {
          const uploadResult = await uploadAPI.uploadImage(photoFile);
          imageUrl = uploadResult.url;
          console.log('Image uploaded successfully:', imageUrl);
        } catch (uploadError: any) {
          console.error('Image upload error:', uploadError);
          throw new Error(`Image upload failed: ${uploadError.message}`);
        }
      } else {
        console.log('No photo file selected');
      }

      // Filter out empty components
      const validComponents = components.filter(c => c.name.trim() !== '');

      // Create item
      const itemData = {
        name,
        description,
        category,
        location,
        quantity,
        ...(barcode ? { barcode } : {}),
        ...(imageUrl ? { image: imageUrl } : {}),
        ...(validComponents.length > 0 ? { components: validComponents } : {}),
      };

      console.log('Creating item with data:', itemData);
      await itemsAPI.create(itemData);

      // Show success
      if (successMessage) {
        successMessage.textContent = 'Item added successfully!';
        successMessage.classList.remove('hidden');
      }

      // Reset form
      form.reset();
      components = [];
      if (componentsContainer) {
        componentsContainer.innerHTML = '';
      }
      imagePreview?.classList.add('hidden');

      // Redirect after 1.5 seconds
      setTimeout(() => {
        window.location.href = '/';
      }, 1500);

    } catch (error: any) {
      if (errorMessage) {
        errorMessage.textContent = error.message || 'Failed to add item';
        errorMessage.classList.remove('hidden');
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Item';
    }
  });
</script>
